name: Build OpenSSL on Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@main # æ£€å‡ºä»£ç 

    - name: Install dependencies
      run: |
        choco install perl
        choco install nasm
        choco install make
        # å®‰è£…å…¶ä»–å¯èƒ½éœ€è¦çš„ä¾èµ–ï¼Œå¦‚VC++ Build Toolsç­‰ï¼Œå¦‚æžœéœ€è¦å¯ä»¥æ·»åŠ 
        
    - name: add NASM to path
      shell: cmd
      run: |
        set path="C:\Program Files\NASM" # å°†NASMæ·»åŠ è¿›çŽ¯å¢ƒå˜é‡ä¸­
     
    - name: Clone source code
      run: |
        git clone https://github.com/openssl/openssl.git


    - name: Configure OpenSSL
      run: |
        cd openssl # å‡è®¾ä½ çš„OpenSSLæºä»£ç åœ¨ä»“åº“çš„opensslç›®å½•ä¸‹
        perl Configure VC-WIN64A no-asm --prefix=C:\OpenSSL_build # æ ¹æ®ä½ çš„éœ€æ±‚é…ç½®OpenSSL

    - name: Build OpenSSL
      run: |
        %comspec% /k "D:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat"
        cd openssl
        nmake
        nmake install

    - name: Archive artifacts
      uses: actions/upload-artifact@main
      with:
        name: openssl-windows
        path: C:\OpenSSL_build # ä¸Šä¼ ç¼–è¯‘å¥½çš„OpenSSLæ–‡ä»¶ä½œä¸ºæž„å»ºäº§ç‰©

    - name: Generate release tag
      run: |
        cd C:\
        7z a openssl-for-windows.zip for windows .\OpenSSL_build\
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "ðŸ”— [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@master
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag1.outputs.release_tag }}
        body_path: release.txt
        files: C:\openssl-for-windows.zip
